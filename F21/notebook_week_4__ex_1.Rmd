---
title: "Basic statistics for health research - week 4, ex. 1"
author: "Benjamin Skov Kaas-Hansen"
date: "3/3/2021"
output: 
  html_document: 
    code_folding: show
    df_print: kable
    highlight: haddock
    theme: paper
    toc: yes
---

### Setup and loading packages

```{r setup, warning=FALSE, message=FALSE}
library(tidyverse) # dplyr, readr and ggplot2 (+ others we won't use)

library(lindia) # for diagnostic plots of (generalised) linear models
```

### 0. Helper functions

```{r}
pretty_estimates <- function(m) { # m: model object
	cbind(Est. = m$coefficients, confint(m))
}
```

## Resting metabolic rate

### 1. 

As before, there's an extrac (empty) column. Note that unfortunate naming (the dataframe has the same name as one of its columns.)
```{r}
rmr <- read_delim("http://publicifsv.sund.ku.dk/~lts/basal/data/rmr.txt", delim = " ")

rmr_scatter <- ggplot(rmr, aes(x = bw, y = rmr)) +
	geom_point() +
	labs(x = "Body weight", y = "Resting metabolic rate")

rmr_scatter
```

### 2. 
We just build on the scatterplot make above, no need to recreate it from scratch.
```{r}
rmr_scatter +
	stat_smooth()
```

```{r}
model1 <- lm(rmr ~ bw, data = rmr)
summary(model1)

pretty_estimates(model1) # helper function defined at the top
```

### 3. 
```{r}
predict(model1, newdata = data.frame(bw = 70), interval = "confidence")

# The three are all equivalent (but the last definitely a hassle)
40:140
seq(40, 140)
c(40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140)

new_df <- data.frame(bw = 40:140)
predict(model1, newdata = new_df, se.fit = TRUE)

pred_df <- new_df %>% 
	mutate(estimate = predict(model1, newdata = new_df))

predl <- predict(model1, newdata = new_df, interval = "prediction") %>% 
	as.data.frame() %>% 
	bind_cols(new_df)
	
confl <- predict(model1, newdata = new_df, interval = "confidence") %>% 
	as.data.frame() %>% 
	bind_cols(new_df)

head(pred_df)
head(predl)
head(confl)

ggplot() +
	geom_ribbon(aes(x = bw, ymin = lwr, ymax = upr, fill = "Prediction interval"), predl, alpha = 0.5) +
	geom_ribbon(aes(x = bw, ymin = lwr, ymax = upr, fill = "Confidence interval"), confl, alpha = 0.5) +
	geom_line(aes(x = bw, y = estimate), pred_df) +
	geom_point(aes(x = bw, y = rmr), rmr) +
	labs(x = "Body weight", y = "Resting metabolic rate (observed values as points)")
```

### 4. 
```{r}
predict(model1, newdata = data.frame(bw=80), interval = "prediction")

250/157.9

pnorm(250/157.9)
```

### 5. Diagnostic plots
There are 4 assumptions of (basic) linear models that you should ascertain are fulfilled:
- Independence between observations
- Linearity
- Variance homogeneity (constant variance around the line, independent of height)
- Residuals are Normally distributed (there is *no* assumption that the data themselves must be Normal!)

```{r}
gg_diagnose(model1)
```

### 6. 
```{r}
plot(model1,which=4, cex.lab=1.5)

qplot(x = rmr$bw, y = influence(model1)$coefficients[, 2]) +
	labs(x = "Body weight", y = "Influence on slope")
```

```{r}
rmr2 <- rmr %>% 
	filter(rmr < 2000)

model2 <- lm(rmr ~ bw, data = rmr2)
summary(model2)
pretty_estimates(model2)
```

## Sundby revisisted

### 2.
```{r}
su <- read_delim("http://publicifsv.sund.ku.dk/~lts/basal/data/sundby_lille.txt", delim = " ", na = ".") %>% 
	transmute(sex = factor(kon, levels = 1:2, labels = c("Male", "Female")),
			  weight = v75,
			  height = v76 / 100, # cm. = metres
			  bmi = weight / height^2,
			  log_height = log(height),
			  log_weight = log(weight),
			  log_bmi = log(bmi))
```

### 2. Scatterplots, each sex separately
```{r}
ggplot(su, aes(x = log(height), y = log(weight))) +
	geom_point(alpha = 0.3, size = 0.5) +
	geom_smooth(aes(colour = "Linear"), method = "lm", se = FALSE, size = 0.5) +
	geom_smooth(aes(colour = "LOESS"), method = "loess", se = FALSE, size = 0.5) +
	facet_wrap(~ sex)
```

### 4. Linar models for each sex
```{r}
lm_women <- lm(log_weight ~ log_height, data = filter(su, sex == "Female"))
lm_men <- lm(log_weight ~ log_height, data = filter(su, sex == "Male"))
```


summary(model.F)

summary(model.M)

#SPM 5

su$bmi=su$vaegt/su$hoejde^2;
su$log10bmi=log10(su$bmi)

su.F = su[su$gender=="FEMALE",]
su.M = su[su$gender=="MALE",]

with(su.F,cor.test(log10hoejde, log10bmi, method="spearman"))
with(su.M,cor.test(log10hoejde, log10bmi, method="spearman"))

with(su.F,cor.test(log10hoejde, log10bmi, method="spearman"))
with(su.M,cor.test(log10hoejde, log10bmi, method="spearman"))



